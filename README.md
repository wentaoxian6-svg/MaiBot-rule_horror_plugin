# 规则怪谈插件 (Rule Horror Plugin)

一个为MaiBot设计的规则怪谈互动游戏插件，支持LLM生成内容、单人/多人游戏模式、提示系统和多种结局判定。

## 游玩建议

1. 在进入规则怪谈之前，将麦麦的思考频率调至0，并关闭提及必回复。
2. 插件配置的模型温度保持在0.7以上、1.5以下。
3. 推荐使用智商较高、使用成本较低的模型游玩（如deepseek-v3.2）。
4. 如果你不缺钱，只需要使用智商高的模型即可。

## 安装说明

### 环境要求
- Python 3.12+
- MaiBot框架
- LLM API服务（支持OpenAI格式的API）

### 安装步骤
1. 将插件文件夹复制到MaiBot的plugins目录
2. 安装依赖项：
   ```
   pip install -r requirements.txt
   ```
3. 配置LLM API（见配置说明部分）
4. 重启MaiBot以加载插件

！！！一键包用户使用控制台"交互式安装pip模块"安装依赖！！！

## 配置说明

### LLM API配置
在 `config.toml` 文件中配置LLM API：

```toml
[llm]
api_url = "http://rinkoai.com/v1/chat/completions"
api_key = "YOUR_API_KEY"
model = "deepseek-ai/DeepSeek-V3"
temperature = 0.8
```

**配置项说明**：
- `api_url`: LLM API地址，需支持OpenAI格式
- `api_key`: API密钥
- `model`: 使用的模型名称
- `temperature`: 生成文本的随机性（0.0-1.0），值越高越随机

### 插件启用配置
```toml
[plugin]
enabled = true
config_version = "1.0.0"
```

## 使用指南

### 基本命令

#### 开始游戏
```
/rg 开始 单人
/rg 开始 多人
```
- 单人模式：自动加入游戏，独自挑战
- 多人模式：最多5人参与，需要手动加入

#### 强制开始游戏
```
/rg 强制开始 单人
/rg 强制开始 多人
```
- 强制开始新游戏，会覆盖现有存档

#### 恢复存档
```
/rg 恢复
```
- 恢复默认存档游戏

#### 手动保存
```
/rg 保存 <存档名称>
```
- 手动保存当前游戏状态，使用自定义名称
- 可以创建多个存档，方便在不同进度间切换

#### 读取存档
```
/rg 读取 <存档名称>
```
- 从指定存档读取游戏

#### 查看存档列表
```
/rg 存档列表
```
- 查看所有可用存档，包括存档名称、时间、场景和状态

#### 加入/离开游戏
```
/rg 加入
/rg 离开
```
- 多人模式下使用，加入或离开当前游戏

#### 查看游戏状态
```
/rg 状态
```
- 显示当前游戏状态、玩家信息和提示次数

#### 查看规则
```
/rg 规则
```
- 显示当前规则和通关条件

#### 查看场景结构
```
/rg 场景
```
- 显示详细的场景结构，包括建筑类型、楼层、房间布局等

#### 获取提示
```
/rg 提示 规则
/rg 提示 线索
```
- 获取规则验证或线索提示（剩余3次机会）

#### 记录推理
```
/rg 推理 <推理内容>
```
- 记录你的推理过程

#### 描述行动
```
/rg 行动 <行动描述>
```
- 描述你的行动，系统会判断行动后果

#### 继续探索完美结局
```
/rg 继续
```
- 达成通关条件后，继续探索以达成完美结局

#### 结束游戏
```
/rg 结束
```
- 结束游戏并判定结局

#### 查看帮助
```
/rg 帮助
```
- 显示所有可用命令和使用说明

### 游戏流程

#### 单人模式流程
1. 使用 `/rg 开始 单人` 开始游戏
2. 系统自动生成规则怪谈场景、场景结构和规则，并以长图形式展示
   - 剧情导入长图：展示场景名称、背景故事和玩家到来原因
   - 场景结构立体剖面图：可视化展示建筑结构
   - 规则长图：清晰展示所有规则和通关条件
3. 阅读规则，分析隐藏的逻辑
4. 使用 `/rg 场景` 查看详细的场景结构
5. 使用 `/rg 推理` 记录你的推理
6. 使用 `/rg 行动` 描述你的行动
7. 行动后会显示详细的场景描述和角色状态更新
8. 必要时使用 `/rg 提示` 获取帮助
9. 使用 `/rg 状态` 查看当前游戏状态和角色状态
10. 系统会自动判断是否达成通关条件
11. 达成通关后，可选择：
    - 使用 `/rg 继续` 继续探索完美结局
    - 使用 `/rg 结束` 结束游戏并查看结局
12. 游戏结束后，存档和所有临时图片会自动清理

#### 多人模式流程
1. 使用 `/rg 开始 多人` 开始游戏
2. 系统生成游戏信息，并以长图形式展示
   - 剧情导入长图：展示场景名称、背景故事和玩家到来原因
   - 场景结构立体剖面图：可视化展示建筑结构
   - 规则长图：清晰展示所有规则和通关条件
   - 多人模式开始提示图：展示操作指引
3. 其他玩家使用 `/rg 加入` 加入游戏（最多5人）
4. 每位玩家独立进行推理和行动
5. 使用 `/rg 状态` 查看所有玩家状态和角色状态
6. 使用 `/rg 场景` 查看详细的场景结构
7. 系统会自动判断是否达成通关条件
8. 达成通关后，可选择：
   - 使用 `/rg 继续` 继续探索完美结局
   - 使用 `/rg 结束` 结束游戏并查看结局
9. 游戏结束后，存档和所有临时图片会自动清理

### 结局判定

游戏结束时，系统会根据玩家的推理和行动判定结局：

- **完美**：推理出规则怪谈的原貌、达成通关条件、并解除规则怪谈（解决根源）
- **成功**：推理出规则怪谈的原貌并成功通关，但未解除规则怪谈
- **通关**：达成通关条件，但未完全理解规则真相
- **失败**：玩家死亡或未能达成通关条件

### 提示系统

每位玩家（或整个游戏）有3次提示机会：

- **规则提示**：验证某条规则的真实含义
- **线索提示**：获取关于通关的额外线索

提示次数用完后将无法再获取提示。

## 存档功能

### 自动保存
游戏状态会在以下情况下自动保存：
- 开始新游戏
- 玩家加入/离开
- 记录推理或行动
- 获取提示

### 手动保存
除了自动保存外，玩家还可以手动创建多个命名存档：

```
/rg 保存 <存档名称>
```

**手动存档的特点**：
- 使用自定义名称保存游戏状态
- 可以创建多个存档，方便在不同进度间切换
- 保存内容包括：生成的规则、游戏状态、角色状态、场景结构、时间系统、环境状况、物品等所有游戏数据
- 每个存档独立存储，互不影响

### 存档位置
存档文件保存在插件的 `data` 目录下：
- 默认存档：`{group_id}.json`
- 手动存档：`{group_id}_{存档名称}.json`

### 恢复存档

#### 恢复默认存档
```
/rg 恢复
```
恢复默认存档游戏。

#### 读取指定存档
```
/rg 读取 <存档名称>
```
从指定的命名存档读取游戏。

### 查看存档列表
```
/rg 存档列表
```
查看所有可用存档，包括：
- 存档名称
- 保存时间
- 游戏模式
- 场景信息
- 存档状态（可用/已结束）

### 存档管理建议
- 在关键节点（如发现重要线索、进入新区域前）创建手动存档
- 使用有意义的存档名称，便于识别不同进度
- 定期清理不再需要的存档
- 游戏结束后，已结束的存档会自动清理

## 功能特点

### 核心功能
- **LLM内容生成** - 使用大语言模型自动生成规则怪谈场景和规则
- **完整场景结构** - 生成详细的建筑结构，包括楼层、房间布局、通道和特殊区域
- **沉浸式氛围系统** - 动态环境系统，包括时间流逝、光线变化、温度感知、声音和气味描述
- **理智值动态描述** - 根据角色理智值动态调整场景描述风格（理智低时描述更混乱、恐怖）
- **理智崩溃机制** - 当理智值低于30时，场景描述会变得诡异、充满诱导性，直接与玩家对话试图颠覆逻辑
- **规则变异系统** - 规则会基于玩家推理、行动和剧情推进判断是否需要变化
  - 智能判断：基于LLM评估玩家的推理、行动和剧情推进，决定是否触发规则变异
  - 冷却时间：两次变异之间至少间隔10分钟
  - 变异记录：记录每次变异的时间、触发原因、旧规则和新规则
- **身份变化规则系统** - 当玩家身份发生变化时，规则会相应更新
  - 身份识别：系统识别玩家身份的变化（如从员工变为主管）
  - 规则替换：根据新身份替换对应的规则
  - 规则发现机制：新规则不会自动显示，玩家需要通过探索发现（如找到手册、记录等）
  - 多人模式独立：多人模式下，每个玩家的规则独立管理，只有身份变化的玩家才会收到新规则
- **环境记忆系统** - 记录玩家的环境互动历史，避免重复描述
  - 访问记录：记录玩家访问过的地点
  - 互动记录：记录玩家互动过的物体
  - 时间事件：记录基于时间的事件
  - 智能描述：在生成场景描述时，避免重复描述已访问的地点和已互动的物体
- **规则网络系统** - 规则与真相之间具有因果关系，形成规则网络
  - 因果关系：每条规则与隐藏真相的特定元素相关联
  - 网络结构：规则之间相互关联，形成完整的规则网络
  - 推理辅助：玩家可以通过规则网络推理出隐藏真相
- **多人协作规则** - 多人模式下，概率生成需要协作才能发现的规则
  - 协作要求：某些规则需要多个玩家共同行动才能发现
  - 概率生成：有一定概率生成协作规则
  - 协作检测：系统检测玩家们的联合行动是否满足协作规则要求
  - 协作提示：当满足协作条件时，系统会提示玩家发现了新规则
- **死亡场景增强** - 玩家死亡时，场景描述会包含违规规则信息
  - 违规提示：明确指出玩家违反了哪条规则
  - 死因分析：分析死亡原因与规则违反的关系
  - 教训总结：总结玩家在规则理解上的错误
- **多人个性化体验** - 多人模式下，每个玩家根据自己的理智值看到不同的场景描述
  - **角色状态系统** - 跟踪玩家身体状况（体力值、受伤、疲劳）和精神状况（理智值、精神状态、情绪）
  - **心理压力系统** - 实时跟踪恐惧等级、焦虑等级和压力等级
  - **物品和背包系统** - 支持物品发现、收集和使用
- **随机环境事件** - 动态生成环境变化和随机事件，增强游戏张力
- **单人/多人模式** - 支持单人挑战和最多5人的多人协作游戏
- **智能提示系统** - 提供3次提示机会，支持规则验证和线索获取
- **推理记录** - 记录玩家的推理过程，便于回顾和分析
- **行动判定** - 基于LLM判断玩家行动的后果，并更新角色状态
- **详细场景描述** - 行动后提供细致的场景描述，包括位置、视觉细节、听觉、嗅觉、触觉等多感官体验
- **自动通关判定** - 根据玩家推理和行动自动判断是否达成通关条件
- **完美结局探索** - 达成通关后可继续探索完美结局
- **多种结局** - 支持完美、成功、通关、失败四种结局判定
- **存档/读档** - 支持游戏存档，中断后可继续游戏
- **手动存档** - 支持创建多个命名存档，方便在不同进度间切换
- **存档管理** - 支持查看所有可用存档列表
- **自动清理存档** - 游戏结束后自动删除已结束的存档文件
- **视觉化信息展示** - 自动生成多种长图，提升游戏沉浸感

### 技术特性
- **异步API调用** - 使用aiohttp进行异步LLM API请求
- **游戏状态管理** - 完整的游戏状态跟踪和持久化
- **多人协作** - 独立的玩家状态跟踪，支持多人同时参与
- **自动保存** - 游戏状态变更时自动保存
- **灵活配置** - 支持自定义LLM API地址、密钥和模型参数

## 开发文档

### 代码结构
```
rule_horror_plugin-main/
├── plugin.py              # 主插件文件，包含所有游戏逻辑
├── _manifest.json        # 插件清单文件
├── config.toml           # 配置文件
├── requirements.txt      # Python依赖
├── README.md            # 本文档
└── data/                # 数据目录
    ├── temp_images/     # 临时图片目录，存储游戏过程中生成的长图
    └── *.json          # 存档文件
```

### 核心类说明

#### RuleHorrorPlugin
插件主类，继承自BasePlugin，负责插件注册和配置管理。

#### RuleHorrorCommand
命令处理类，继承自BaseCommand，处理所有 `/rg` 命令。

### 游戏状态结构
```python
{
    "scene": "场景描述",
    "scene_structure": "详细的场景结构描述，包括建筑类型、楼层数、每层的房间布局、通道、特殊区域等",
    "rules": ["规则1", "规则2", ...],
    "win_condition": "通关条件",
    "resolve_condition": "解除条件（解决规则怪谈根源的条件）",
    "hidden_truth": "隐藏真相",
    "death_triggers": ["死亡触发1", ...],
    "hints_used": 0,
    "max_hints": 3,
    "game_active": True,
    "max_players": 5,
    "game_mode": "多人",
    "scene_image_path": "场景图片路径（用于游戏结束后删除）",
    "rules_image_path": "规则长图路径（用于游戏结束后删除）",
    "time_system": {
        "current_time": "当前游戏时间",
        "time_description": "时间描述",
        "elapsed_minutes": 0
    },
    "environment": {
        "lighting": "光线状况",
        "temperature": "温度",
        "sounds": ["声音列表"],
        "smells": ["气味列表"],
        "atmosphere": "氛围"
    },
    "random_events": [],
    "rule_network": {
        "rule_connections": [
            {
                "rule": "规则内容",
                "related_truth_elements": ["相关真相元素1", "相关真相元素2"],
                "causal_relationship": "因果关系描述"
            }
        ],
        "collaborative_rules": [
            {
                "rule": "需要协作发现的规则",
                "required_players": 2,
                "required_actions": ["行动1", "行动2"],
                "discovered": False
            }
        ]
    },
    "environment_memory": {
        "visited_locations": ["地点1", "地点2"],
        "interacted_objects": ["物体1", "物体2"],
        "time_based_events": [
            {
                "time": "时间点",
                "event": "事件描述"
            }
        ]
    },
    "players": {
        "user_id": {
            "name": "玩家名称",
            "identity": "玩家身份",
            "personal_rules": ["个人规则1", "个人规则2"],
            "pending_rules": ["待发现规则1", "待发现规则2"],
            "reasoning_history": [],
            "action_history": [],
            "is_alive": True,
            "physical_status": {
                "health": 100,
                "injury": "无",
                "fatigue": "无"
            },
            "mental_status": {
                "sanity": 100,
                "state": "正常",
                "emotion": "平静"
            },
            "psychological_pressure": {
                "fear_level": 0,
                "anxiety_level": 0,
                "stress_level": 0
            },
            "inventory": [],
            "location": "玩家当前位置"
        }
    }
}
```

## 故障排除

### 常见问题

#### 1. LLM API调用失败
- 检查API地址和密钥配置是否正确
- 确认网络连接正常
- 查看MaiBot日志获取详细错误信息

#### 2. 游戏无法开始
- 确认插件已启用（config.toml中enabled=true）
- 检查LLM API配置是否正确
- 查看日志文件排查错误

#### 3. 存档无法恢复
- 确认存档文件存在于data目录
- 检查存档文件是否损坏
- 尝试使用 `/rg 强制开始` 开始新游戏
- 对于手动存档，使用 `/rg 存档列表` 查看所有可用存档

#### 4. 手动存档失败
- 确认当前有正在进行的游戏
- 检查存档名称是否包含非法字符
- 确认data目录有写入权限

#### 5. 提示无响应
- 检查提示次数是否已用完
- 确认LLM API连接正常
- 尝试重新发送命令

### 日志查看
插件日志通常位于MaiBot的日志目录中，文件名包含"rule_horror"。

## 版本历史

### v1.4.0
- 优化规则变异系统
  - 规则变化现在基于玩家推理、行动和剧情推进进行智能判断，不再是自动触发
  - 移除了关键物品触发机制，改为基于剧情推进的LLM评估
  - 移除了随机概率触发机制，改为更智能的判断逻辑
- 新增身份变化规则系统
  - 当玩家身份发生变化时，系统会自动替换对应的规则
  - 新规则不会自动显示，玩家需要通过探索发现（如找到手册、记录等）
  - 多人模式下，每个玩家的规则独立管理，只有身份变化的玩家才会收到新规则
- 新增环境记忆系统
  - 记录玩家访问过的地点、互动过的物体和基于时间的事件
  - 在生成场景描述时，避免重复描述已访问的地点和已互动的物体
  - 提升游戏体验，避免重复内容
- 新增规则网络系统
  - 规则与隐藏真相之间建立因果关系，形成完整的规则网络
  - 每条规则与隐藏真相的特定元素相关联
  - 规则之间相互关联，帮助玩家推理出隐藏真相
- 新增多人协作规则
  - 多人模式下，有一定概率生成需要协作才能发现的规则
  - 系统检测玩家们的联合行动是否满足协作规则要求
  - 当满足协作条件时，系统会提示玩家发现了新规则
- 增强死亡场景描述
  - 玩家死亡时，场景描述会明确指出违反了哪条规则
  - 分析死亡原因与规则违反的关系
  - 总结玩家在规则理解上的错误
- 优化图片删除逻辑
  - 确保所有图片发送成功后再删除文件
  - 添加发送状态检查和错误处理
  - 避免图片在发送过程中被删除导致显示失败

### v1.3.1
- 新增视觉化信息展示功能
  - **剧情导入长图** - 展示场景名称、背景故事和玩家到来原因
  - **场景结构立体剖面图** - 可视化展示建筑结构，包括楼层、房间、通道和特殊区域
  - **场景结构文字描述图** - 详细展示场景结构文字描述
  - **规则长图** - 清晰展示所有规则和通关条件
  - **多人模式开始提示图** - 展示多人模式操作指引
- 新增自动清理图片功能
  - 游戏结束后自动删除所有生成的临时图片文件
  - 包括场景图片和规则长图
  - 增加异常处理和日志输出

### v1.3.0
- 新增理智崩溃机制
  - 当理智值低于30时，触发理智崩溃状态
  - 理智崩溃时，场景描述会变得诡异、充满诱导性
  - 系统会直接与玩家对话，试图颠覆之前的全部逻辑
  - 否认"死亡"概念，描述为"接纳"、"融合"、"永恒"
  - 暗示规则是牢笼，打破它才能获得自由
- 新增规则变异系统
  - 规则会基于关键物品发现和随机概率发生变异
  - 关键物品触发：发现或使用关键物品时必定触发规则变异
  - 随机触发：每次行动后有概率触发规则变异，基础概率5%，随时间推移逐渐增加（最高35%）
  - 冷却时间：两次变异之间至少间隔10分钟
  - 变异记录：记录每次变异的时间、触发原因、旧规则和新规则
  - 变异后的规则暗示场景本身是有意识的、会学习的
  - 变异规则看起来像是原本就存在，只是之前被玩家忽视了
- 新增关键物品系统
  - LLM在生成物品时会标记关键物品
  - 关键物品通常带有奇怪符号、与场景历史相关或暗示真相
  - 只有极少数物品是关键物品
  - 发现或使用关键物品会触发规则变异
- 新增多人个性化体验
  - 多人模式下，每个玩家根据自己的理智值看到不同的场景描述
  - 区分行动玩家和其他玩家的视角
  - 每个玩家的物品和状态独立管理
- 优化行动处理逻辑
  - 将单人模式和多人模式的行动处理分离为独立方法
  - 提高代码可维护性和可读性
  - 减少代码重复，提升性能
- 增强场景描述的个性化
  - 根据玩家理智值（>70/40-70/<40）动态调整描述风格
  - 理智值高时描述客观清晰、冷静理性
  - 理智值中等时开始出现混乱和恐惧元素
  - 理智值低时描述混乱恐怖、充满幻觉和错觉

### v1.2.2
- 优化场景结构生成，使用结构化JSON格式
  - 将场景结构从单个长文本字段改为结构化字段（建筑类型、楼层、通道、特殊区域）
  - 减少LLM生成文本量，显著提升生成速度
  - 改善场景结构显示格式，更加清晰易读
- 更新游戏状态存储格式，适配新的场景结构数据结构
- 更新存档/读档功能，支持新的场景结构格式

### v1.2.1
- 新增剧情导入部分
- 优化游戏生成流程，实现分步发送以避免长文本截断
  - 生成剧情导入后立即发送
  - 生成场景结构后立即发送
  - 生成规则后立即发送
  - 最后发送玩家信息和操作提示
- 新增剧情导入查看功能，使用 `/rg 剧情` 命令查看场景名称、背景故事和玩家到来原因
- 优化 `/rg 场景` 命令，只显示场景结构和环境状况
- 优化 `/rg 规则` 命令，只显示规则和通关条件

### v1.2.0
- 新增沉浸式氛围系统，包括时间流逝、光线变化、温度感知、声音和气味描述
- 新增理智值动态描述系统，根据角色理智值动态调整场景描述风格
  - 理智值高（>70）：客观清晰、冷静理性的描述
  - 理智值中等（40-70）：开始出现混乱和恐惧元素
  - 理智值低（<40）：混乱恐怖、充满幻觉和错觉的描述
- 新增心理压力系统，实时跟踪恐惧等级、焦虑等级和压力等级
- 新增物品和背包系统，支持物品发现、收集和使用
- 新增随机环境事件系统，动态生成环境变化和随机事件
- 新增玩家位置跟踪，记录玩家在场景中的具体位置
- 新增手动存档功能，支持创建多个命名存档，方便在不同进度间切换
- 新增存档管理功能，支持查看所有可用存档列表
- 新增 `/rg 保存 <存档名称>` 命令，手动保存当前游戏状态
- 新增 `/rg 读取 <存档名称>` 命令，从指定存档读取游戏
- 新增 `/rg 存档列表` 命令，查看所有可用存档
- 增强场景描述，包含位置、视觉细节、听觉、嗅觉、触觉等多感官体验
- 优化LLM提示词，确保生成更详细和沉浸式的场景描述
- 扩展随机事件库，增加更多样化的环境变化和突发事件

### v1.1.0
- 新增完整场景结构生成，包括建筑类型、楼层、房间布局、通道和特殊区域
- 新增角色状态系统，跟踪身体状况（体力值、受伤、疲劳）和精神状况（理智值、精神状态、情绪）
- 新增 `/rg 规则` 命令，查看当前规则和通关条件
- 新增 `/rg 场景` 命令，查看详细的场景结构
- 增强行动判定，行动后提供详细的场景描述和角色状态更新
- 优化游戏状态显示，展示详细的角色状态信息
- 新增自动清理存档功能，游戏结束后自动删除已结束的存档文件
- 修复JSON解析失败的问题，增加正则表达式提取和错误处理
- 修复用户信息获取失败的问题，创建统一的用户信息获取方法

### v1.0.0
- 初始版本发布
- 支持单人/多人游戏模式
- LLM内容生成
- 提示系统（3次机会）
- 推理和行动记录
- 多种结局判定
- 存档/读档功能
- 自动保存机制

## 许可证

本插件遵循MIT许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：
作者：岚影鸿夜（QQ：1485272140）

---

**注意**: 
- 本插件需要LLM API服务才能正常工作。请确保已正确配置API地址和密钥。
- 本插件仍在持续更新，遇到bug请联系作者修复！
