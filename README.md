# 规则怪谈插件 (Rule Horror Plugin)

一个为MaiBot设计的规则怪谈互动游戏插件，支持LLM生成内容、单人/多人游戏模式、提示系统和多种结局判定。

## 功能特点

### 🎮 核心功能
- **LLM内容生成** - 使用大语言模型自动生成规则怪谈场景和规则
- **完整场景结构** - 生成详细的建筑结构，包括楼层、房间布局、通道和特殊区域
- **沉浸式氛围系统** - 动态环境系统，包括时间流逝、光线变化、温度感知、声音和气味描述
- **理智值动态描述** - 根据角色理智值动态调整场景描述风格（理智低时描述更混乱、恐怖）
- **角色状态系统** - 跟踪玩家身体状况（体力值、受伤、疲劳）和精神状况（理智值、精神状态、情绪）
- **心理压力系统** - 实时跟踪恐惧等级、焦虑等级和压力等级
- **物品和背包系统** - 支持物品发现、收集和使用
- **随机环境事件** - 动态生成环境变化和随机事件，增强游戏张力
- **单人/多人模式** - 支持单人挑战和最多5人的多人协作游戏
- **智能提示系统** - 提供3次提示机会，支持规则验证和线索获取
- **推理记录** - 记录玩家的推理过程，便于回顾和分析
- **行动判定** - 基于LLM判断玩家行动的后果，并更新角色状态
- **详细场景描述** - 行动后提供细致的场景描述，包括位置、视觉细节、听觉、嗅觉、触觉等多感官体验
- **自动通关判定** - 根据玩家推理和行动自动判断是否达成通关条件
- **完美结局探索** - 达成通关后可继续探索完美结局
- **多种结局** - 支持完美、成功、通关、失败四种结局判定
- **存档/读档** - 支持游戏存档，中断后可继续游戏
- **自动清理存档** - 游戏结束后自动删除已结束的存档文件

### 🤖 技术特性
- **异步API调用** - 使用aiohttp进行异步LLM API请求
- **游戏状态管理** - 完整的游戏状态跟踪和持久化
- **多人协作** - 独立的玩家状态跟踪，支持多人同时参与
- **自动保存** - 游戏状态变更时自动保存
- **灵活配置** - 支持自定义LLM API地址、密钥和模型参数

## 安装说明

### 环境要求
- Python 3.7+
- MaiBot框架
- LLM API服务（支持OpenAI格式的API）

### 安装步骤
1. 将插件文件夹复制到MaiBot的plugins目录
2. 安装依赖项：
   ```
   pip install -r requirements.txt
   ```
3. 配置LLM API（见配置说明部分）
4. 重启MaiBot以加载插件

！！！一键包用户使用控制台"交互式安装pip模块"安装依赖！！！

## 配置说明

### LLM API配置
在 `config.toml` 文件中配置LLM API：

```toml
[llm]
api_url = "http://rinkoai.com/v1/chat/completions"
api_key = "YOUR_API_KEY"
model = "deepseek-ai/DeepSeek-V3"
temperature = 0.8
```

**配置项说明**：
- `api_url`: LLM API地址，需支持OpenAI格式
- `api_key`: API密钥
- `model`: 使用的模型名称
- `temperature`: 生成文本的随机性（0.0-1.0），值越高越随机

### 插件启用配置
```toml
[plugin]
enabled = true
config_version = "1.0.0"
```

## 使用指南

### 基本命令

#### 开始游戏
```
/rg 开始 单人
/rg 开始 多人
```
- 单人模式：自动加入游戏，独自挑战
- 多人模式：最多5人参与，需要手动加入

#### 强制开始游戏
```
/rg 强制开始 单人
/rg 强制开始 多人
```
- 强制开始新游戏，会覆盖现有存档

#### 恢复存档
```
/rg 恢复
```
- 恢复之前保存的游戏进度

#### 加入/离开游戏
```
/rg 加入
/rg 离开
```
- 多人模式下使用，加入或离开当前游戏

#### 查看游戏状态
```
/rg 状态
```
- 显示当前游戏状态、玩家信息和提示次数

#### 查看规则
```
/rg 规则
```
- 显示当前规则和通关条件

#### 查看场景结构
```
/rg 场景
```
- 显示详细的场景结构，包括建筑类型、楼层、房间布局等

#### 获取提示
```
/rg 提示 规则
/rg 提示 线索
```
- 获取规则验证或线索提示（剩余3次机会）

#### 记录推理
```
/rg 推理 <推理内容>
```
- 记录你的推理过程

#### 描述行动
```
/rg 行动 <行动描述>
```
- 描述你的行动，系统会判断行动后果

#### 继续探索完美结局
```
/rg 继续
```
- 达成通关条件后，继续探索以达成完美结局

#### 结束游戏
```
/rg 结束
```
- 结束游戏并判定结局

#### 查看帮助
```
/rg 帮助
```
- 显示所有可用命令和使用说明

### 游戏流程

#### 单人模式流程
1. 使用 `/rg 开始 单人` 开始游戏
2. 系统自动生成规则怪谈场景、场景结构和规则
3. 阅读规则，分析隐藏的逻辑
4. 使用 `/rg 场景` 查看详细的场景结构
5. 使用 `/rg 推理` 记录你的推理
6. 使用 `/rg 行动` 描述你的行动
7. 行动后会显示详细的场景描述和角色状态更新
8. 必要时使用 `/rg 提示` 获取帮助
9. 使用 `/rg 状态` 查看当前游戏状态和角色状态
10. 系统会自动判断是否达成通关条件
11. 达成通关后，可选择：
    - 使用 `/rg 继续` 继续探索完美结局
    - 使用 `/rg 结束` 结束游戏并查看结局
12. 游戏结束后，存档会自动清理

#### 多人模式流程
1. 使用 `/rg 开始 多人` 开始游戏
2. 其他玩家使用 `/rg 加入` 加入游戏（最多5人）
3. 每位玩家独立进行推理和行动
4. 使用 `/rg 状态` 查看所有玩家状态和角色状态
5. 使用 `/rg 场景` 查看详细的场景结构
6. 系统会自动判断是否达成通关条件
7. 达成通关后，可选择：
   - 使用 `/rg 继续` 继续探索完美结局
   - 使用 `/rg 结束` 结束游戏并查看结局
8. 游戏结束后，存档会自动清理

### 结局判定

游戏结束时，系统会根据玩家的推理和行动判定结局：

- **完美**：推理出规则怪谈的原貌、达成通关条件、并解除规则怪谈（解决根源）
- **成功**：推理出规则怪谈的原貌并成功通关，但未解除规则怪谈
- **通关**：达成通关条件，但未完全理解规则真相
- **失败**：玩家死亡或未能达成通关条件

### 提示系统

每位玩家（或整个游戏）有3次提示机会：

- **规则提示**：验证某条规则的真实含义
- **线索提示**：获取关于通关的额外线索

提示次数用完后将无法再获取提示。

## 存档功能

### 自动保存
游戏状态会在以下情况下自动保存：
- 开始新游戏
- 玩家加入/离开
- 记录推理或行动
- 获取提示

### 存档位置
存档文件保存在插件的 `data` 目录下，文件名格式为：`{group_id}.json`

### 恢复存档
当游戏中断后，使用 `/rg 恢复` 命令可以继续游戏。如果存在未完成的存档，开始新游戏时会提示先恢复存档或强制开始。

## 开发文档

### 代码结构
```
rule_horror_plugin-main/
├── plugin.py              # 主插件文件，包含所有游戏逻辑
├── _manifest.json        # 插件清单文件
├── config.toml           # 配置文件
├── requirements.txt      # Python依赖
├── README.md            # 本文档
└── data/                # 存档目录
```

### 核心类说明

#### RuleHorrorPlugin
插件主类，继承自BasePlugin，负责插件注册和配置管理。

#### RuleHorrorCommand
命令处理类，继承自BaseCommand，处理所有 `/rg` 命令。

### 游戏状态结构
```python
{
    "scene": "场景描述",
    "scene_structure": "详细的场景结构描述，包括建筑类型、楼层数、每层的房间布局、通道、特殊区域等",
    "rules": ["规则1", "规则2", ...],
    "win_condition": "通关条件",
    "resolve_condition": "解除条件（解决规则怪谈根源的条件）",
    "hidden_truth": "隐藏真相",
    "death_triggers": ["死亡触发1", ...],
    "hints_used": 0,
    "max_hints": 3,
    "game_active": True,
    "max_players": 5,
    "game_mode": "多人",
    "time_system": {
        "current_time": "当前游戏时间",
        "time_description": "时间描述",
        "elapsed_minutes": 0
    },
    "environment": {
        "lighting": "光线状况",
        "temperature": "温度",
        "sounds": ["声音列表"],
        "smells": ["气味列表"],
        "atmosphere": "氛围"
    },
    "random_events": [],
    "players": {
        "user_id": {
            "name": "玩家名称",
            "reasoning_history": [],
            "action_history": [],
            "is_alive": True,
            "physical_status": {
                "health": 100,
                "injury": "无",
                "fatigue": "无"
            },
            "mental_status": {
                "sanity": 100,
                "state": "正常",
                "emotion": "平静"
            },
            "psychological_pressure": {
                "fear_level": 0,
                "anxiety_level": 0,
                "stress_level": 0
            },
            "inventory": [],
            "location": "玩家当前位置"
        }
    }
}
```

## 故障排除

### 常见问题

#### 1. LLM API调用失败
- 检查API地址和密钥配置是否正确
- 确认网络连接正常
- 查看MaiBot日志获取详细错误信息

#### 2. 游戏无法开始
- 确认插件已启用（config.toml中enabled=true）
- 检查LLM API配置是否正确
- 查看日志文件排查错误

#### 3. 存档无法恢复
- 确认存档文件存在于data目录
- 检查存档文件是否损坏
- 尝试使用 `/rg 强制开始` 开始新游戏

#### 4. 提示无响应
- 检查提示次数是否已用完
- 确认LLM API连接正常
- 尝试重新发送命令

### 日志查看
插件日志通常位于MaiBot的日志目录中，文件名包含"rule_horror"。

## 版本历史

### v1.0.0
- 初始版本发布
- 支持单人/多人游戏模式
- LLM内容生成
- 提示系统（3次机会）
- 推理和行动记录
- 多种结局判定
- 存档/读档功能
- 自动保存机制

## 版本历史

### v1.2.0
- 新增沉浸式氛围系统，包括时间流逝、光线变化、温度感知、声音和气味描述
- 新增理智值动态描述系统，根据角色理智值动态调整场景描述风格
  - 理智值高（>70）：客观清晰、冷静理性的描述
  - 理智值中等（40-70）：开始出现混乱和恐惧元素
  - 理智值低（<40）：混乱恐怖、充满幻觉和错觉的描述
- 新增心理压力系统，实时跟踪恐惧等级、焦虑等级和压力等级
- 新增物品和背包系统，支持物品发现、收集和使用
- 新增随机环境事件系统，动态生成环境变化和随机事件
- 新增玩家位置跟踪，记录玩家在场景中的具体位置
- 增强场景描述，包含位置、视觉细节、听觉、嗅觉、触觉等多感官体验
- 优化LLM提示词，确保生成更详细和沉浸式的场景描述
- 扩展随机事件库，增加更多样化的环境变化和突发事件

### v1.1.0
- 新增完整场景结构生成，包括建筑类型、楼层、房间布局、通道和特殊区域
- 新增角色状态系统，跟踪身体状况（体力值、受伤、疲劳）和精神状况（理智值、精神状态、情绪）
- 新增 `/rg 规则` 命令，查看当前规则和通关条件
- 新增 `/rg 场景` 命令，查看详细的场景结构
- 增强行动判定，行动后提供详细的场景描述和角色状态更新
- 优化游戏状态显示，展示详细的角色状态信息
- 新增自动清理存档功能，游戏结束后自动删除已结束的存档文件
- 修复JSON解析失败的问题，增加正则表达式提取和错误处理
- 修复用户信息获取失败的问题，创建统一的用户信息获取方法

## 许可证

本插件遵循MIT许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：
作者：岚影鸿夜（QQ：1485272140）

---

**注意**: 本插件需要LLM API服务才能正常工作。请确保已正确配置API地址和密钥。
